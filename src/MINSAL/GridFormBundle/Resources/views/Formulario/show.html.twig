{% extends 'IndicadoresBundle::standard_layout.html.twig' %}
{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('bundles/gridform/js/jqwidgets4.1/styles/jqx.base.css') }}" type="text/css" media="all" />
    <link rel="stylesheet" href="{{ asset('bundles/gridform/js/jqwidgets4.1/styles/jqx.ui-redmond.css') }}" type="text/css" media="all" />
    <link rel="stylesheet" href="{{ asset('bundles/gridform/css/custom_grid.css') }}" type="text/css" media="all" />

{% endblock stylesheets %}
{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxcore.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxdata.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxbuttons.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxscrollbar.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxmenu.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.sort.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.pager.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.selection.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.edit.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxtabs.js') }}" type="text/javascript"></script>

    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxnumberinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxcheckbox.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxlistbox.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxdropdownlist.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxswitchbutton.js') }}" type="text/javascript"></script>

    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.filter.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.columnsresize.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxscrollbar.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxbuttons.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxcheckbox.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxdropdownlist.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxlistbox.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxmenu.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxcalendar.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxdatetimeinput.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.aggregates.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxdata.export.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/jqxgrid.export.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jquery.mtz.monthpicker.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/parametrosDependencia.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/jqwidgets4.1/globalization/globalize.js') }}" type="text/javascript"></script>

    <script src="{{ asset("bundles/gridform/js/jqwidgets4.1/globalization/globalize.culture.#{app.request.locale}.js") }}" type="text/javascript"></script>

    <script src="{{ asset('bundles/gridform/js/moment/es.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/gridform/js/moment/moment.js') }}" type="text/javascript"></script>
    <script src="{{ asset('bundles/indicadores/js/jquery.searchFilter.js') }}" type="text/javascript"></script>
    {% block frm %}
    {% if periodoSeleccionado != null and parametros.periodo_estructura != '-1' %}
    {% set titulos = Frm.tituloColumnas | jsonDecode(true) %}
    <script type="text/javascript">
        $(document).ready(function () {
            $("#FiltroListadoFormularios").searchFilter({targetSelector: ".formulario", charCount: 2});
            $.jqx.theme = 'ui-redmond';
            listSource = [];
            {% for Frm in Formularios %}
            var initGrid{{Frm.id}} = function () {
                var url = Routing.generate('{{url}}', {id: {{Frm.id}}, periodo_ingreso: '{{parametros.periodo_estructura}}',titulo_frm : '{{titulo}}', datos_frm: $('#frm_').serialize() });
                var fila = 0;
                var pk = '{{Frm.llave_primaria | default ('codigo_variable')}}'

                filaFormula = function(fila, columna){
                    {% if Frm.calculoFilas != ''%}
                        var campos = '{{Frm.calculoFilas}}'.split(',');
                        var filasFormulas = [];
                        campos.forEach(function(nodo, index){
                            formula = nodo.split(':');
                            var campo= new RegExp(formula[0].toString().trim());
                            filasp = /\{F[0-9]{1,3}\}/g;
                            lados_formula = formula[1].split('=');
                            filasFormulas.push(filasp.exec(lados_formula[0]).toString().replace(/\{|\}|F/gi,''));
                        });
                        for(i = 0; i < filasFormulas.length; i++){
                            if (filasFormulas[i] == fila){
                                return true;
                            }

                        }
                    {% endif %}
                    return false;
                }
                var rowbeginedit =  function (row, datafield, columntype, value) {
                    {% if Frm.calculoFilas != '' %}
                        return  !(filaFormula(row, datafield));
                    {% endif %}
                    
                    var clase = cellclass(row, datafield, value);
                    var patt = new RegExp("oculto");
                    if (patt.test(clase))
                        return false;
                };
                
                var cellclass = function (row, columnfield, value) {
                    var editable = $("#jqxgrid{{Frm.id}}").jqxGrid('getcolumnproperty', columnfield, 'editable');
                    var no_edit_class = (editable == false) ? 'celda_no_editable' : '';
                    var oculto_class = ''
                    {% if Frm.areaCosteo() == 'calidad' %}
                        var datarowExp = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', 0);
                        var datarowAct = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', row);
                        if (datarowExp.es_poblacion == 'true' && datarowAct.es_poblacion != 'true'){
                            var num_exp = $("#jqxgrid{{Frm.id}}").jqxGrid('getcellvalue',0, columnfield);
                            oculto_class = (num_exp == '') ? 'oculto': ''
                            
                        }
                    {% endif %}
                    return no_edit_class + ' ' + oculto_class;
                }

                var error = false;
                // prepare the data
                var source =
                {
                    datatype: "json",
                    updaterow: function (rowid, rowdata, commit) {
                        // synchronize with the server - send update command
                        // call commit with parameter etrue if the synchronization with the server is successful
                        // and with parameter false if the synchronization failder.
                        if (rowdata.es_separador != 'true'){
                            if (rowdata.local == 'si'){
                                rowdata.local = 'no';
                                commit(true);
                            } else {
                                $.post(Routing.generate('{{url_save}}', {id: {{Frm.id}}, periodo_ingreso: '{{parametros.periodo_estructura}}' }),
                                            {datos_frm: $('#frm_').serialize(),
                                                pk: pk,
                                                fila: JSON.stringify(rowdata),
                                            },
                                function(resp) {
                                    if (resp.estado == 'ok') {
                                        var commit_ = $("#jqxgrid{{Frm.id}}").jqxGrid('updaterow', rowid, resp.data);
                                        commit(true);
                                        error = false;
                                    }
                                    else {
                                        $('#modal_msj_content').html('<div class="alert alert-danger" role="alert">'+resp.msj+'</div>');
                                        $('#modal_msj').modal('show');
                                        commit(false);
                                    }

                                }, 'json')
                                          .fail(function() {
                                            error = true;
                                            commit(false);
                                            $('#modal_msj_content').html('<div class="alert alert-danger" role="alert">{{'_error_conexion_'|trans}}</div>');
                                            $('#modal_msj').modal('show');
                                          })
                                ;
                            }
                        }
                    },
                    datafields: [
                        {% for campo in Frm.campos %}
                            {% if campo.origenPivote %}
                                {% for campoPivote in pivotes[Frm.id][campo.significadoCampo.codigo] %}
                                    {% if tipos_datos_por_filas[Frm.id] %}
                                        { name: '{{campo.significadoCampo.codigo}}_{{campoPivote.id}}', type: 'string' },
                                    {% else %}
                                        { name: '{{campo.significadoCampo.codigo}}_{{campoPivote.id}}', type: '{{campo.tipoDato.codigo}}' },
                                    {% endif %}
                                    {% if campo.origen or campo.significadoCampo.catalogo != '' %}
                                        { name: '{{campo.significadoCampo.codigo}}Source', value: '{{campo.significadoCampo.codigo}}',
                                            values: { source: {{origenes[Frm.id][campo.significadoCampo.codigo]|raw}}, value: 'id', name: 'descripcion' } },
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% if tipos_datos_por_filas[Frm.id] %}
                                        { name: '{{campo.significadoCampo.codigo}}', type: 'string' },
                                    {% else %}
                                        { name: '{{campo.significadoCampo.codigo}}', type: '{{campo.tipoDato.codigo}}' },
                                    {% endif %}
                                {% if campo.origen or campo.significadoCampo.catalogo != '' %}
                                    { name: '{{campo.significadoCampo.codigo}}Source', value: '{{campo.significadoCampo.codigo}}',
                                        values: { source: {{origenes[Frm.id][campo.significadoCampo.codigo]|raw}}, value: 'id', name: 'descripcion' } },
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                        {name: 'es_poblacion'},
                        {name: 'es_separador'},
                        {name: 'nivel_indentacion'},
                        {name: 'codigo_tipo_control'},
                        {name: 'codigo_tipo_dato'},
                        {name: 'ayuda'},
                        {name: 'alertas'},
                        {name: 'rango'}
                    ],
                    url: url,
                    root: 'data'
                };                
                var dataAdapter = new $.jqx.dataAdapter(source);
                $("#jqxgrid{{Frm.id}}").jqxGrid(
                {
                    width: '100%',
                    columnsheight: {% if Frm.gruposColumnas|length > 0 %}'40px'{% else %}'45px'{% endif %},
                    source: dataAdapter,
                    columnsresize: true,
                    editable: {{editable|default(true)}},
                    {% if (Frm.noOrdenarPorFila) %}
                        sortable: false,
                    {% else %}
                        sortable: true,
                    {% endif %}
                    {% if Frm.ajustarAltoFila %}
                        autorowheight: true,
                        autoheight: true,
                    {% endif %}
                    //altrows: true,
                    {% if mostrar_resumen %}
                        showaggregates: true,
                        showstatusbar: true,
                    {% endif %}
                    filterable: true,
                    editmode: 'click',
                    selectionmode: 'multiplecellsadvanced',
                    {% set columnas_fijas = Frm.columnasFijas|default(0) %}
                    columns: [
                        {% if not(Frm.ocultarNumeroFila) %}
                            {
                              text: '#', sortable: false, filterable: false, editable: false,
                              groupable: false, draggable: false, resizable: false,
                              datafield: '', columntype: 'number', width: 50, pinned: true,
                              cellsrenderer: function (row, column, value) {
                                  return "<div style='margin:4px;'>" + (row + 1) + "</div>";
                              }
                            },
                        {% endif %}
                        {% set indice = 0 %}
                        {% for campo in Frm.campos %}
                            {% set indice = indice+1 %}
                            {% if campo.origenPivote %}
                                {% set Pivotes_ =  pivotes[Frm.id][campo.significadoCampo.codigo] %}
                            {% else %}
                                {% set Pivotes_ = [campo] %}
                            {% endif %}

                            {% for pivote in Pivotes_ %}
                            {
                                {% if editable == true %}
                                    {%if (campo.significadoCampo.codigo == 'cant_mensual'
                                            or campo.significadoCampo.codigo == 'importe_mensual'
                                            or campo.significadoCampo.codigo == 'cant_mensual_calidad'
                                            or campo.significadoCampo.codigo == 'mes_check'
                                        )
                                        and campo.origenPivote %}
                                        {% if pivote.id in meses_activos %}
                                            {% set celda_editable = true %}
                                        {% else %}
                                            {% set celda_editable = false %}
                                        {% endif %}
                                    {% else %}
                                        {% set celda_editable = campo.esEditable  %}
                                    {% endif %}
                                {% else %}
                                    {% set celda_editable = false %}
                                {% endif %}
                                {% if campo.origenPivote %}
                                    text: '{{pivote.descripcion}}',
                                    datafield: '{{campo.significadoCampo.codigo}}_{{pivote.id}}',
                                {% else %}
                                    {% if titulos != null and campo.significadoCampo.codigo in titulos|keys%}
                                        text: '{{titulos[campo.significadoCampo.codigo]}}',
                                    {% else %}
                                        text: '{{campo.significadoCampo.descripcion}}',
                                    {% endif %}
                                    datafield: '{{campo.significadoCampo.codigo}}',
                                {% endif %}
                                align: 'center',
                                cellbeginedit: rowbeginedit,
                                width: {{campo.ancho|default(100)}},
                                {% if indice  <=  columnas_fijas %}
                                    pinned: true,
                                {% endif %}
                                cellsalign: '{{campo.alineacion.codigo|default('left')}}',
                                {% if not celda_editable %}
                                    cellclassname: cellclass,
                                {% else %}
                                    cellclassname: cellclass,
                                {% endif%}
                                editable: {{ (celda_editable)? 'true' : 'false' }},

                                hidden: {{campo.oculto|default('false')}},
                                {% if tipos_datos_por_filas[Frm.id] %}
                                    columntype: 'custom',
                                {% else %}
                                    columntype: '{{campo.tipoControl.codigo}}',
                                {% endif %}
                                {% if campo.esCalculado and mostrar_resumen %} aggregates: ['sum'], {% endif %}
                                {% if campo.tipoControl.codigo == 'datetimeinput' %}
                                    cellsformat: 'dd/MMMM/yyyy HH:mm',
                                {% endif %}
                                {% if campo.origen or campo.significadoCampo.catalogo != '' %} displayfield: '{{campo.significadoCampo.codigo}}Source',
                                    createeditor: function (row, value, editor) {
                                        editor.jqxDropDownList({ source: {{origenes[Frm.id][campo.significadoCampo.codigo]|raw}}, displayMember: 'descripcion', valueMember: 'id' });
                                    },
                                {% endif %}
                                {% if campo.grupoColumnas %} columngroup: '{{campo.grupoColumnas.codigo}}', {% endif %}
                                {% if campo.formato %} cellsformat: '{{campo.formato.formato}}', {% endif %}
                                {% if campo.reglaValidacion %}
                                    validation: function (cell, value) {
                                        if ({{campo.reglaValidacion|raw}}) {
                                            return true;
                                        }
                                        return { result: false, message: "{{campo.msjValidacion|default('_dato_no_valido_')|trans}}" };
                                    },
                                {% endif %}
                                {% if campo.formula %}
                                    cellsrenderer: function (index, datafield, value, defaultvalue, column, rowdata) {
                                        {{campo.formula|raw}};
                                        return "<div  class='jqx-{{campo.alineacion.codigo|default('left')}}-align'>" + dataAdapter.formatNumber(result,'{{campo.formato.formato|default('')}}') + "</div>";
                                    },
                                {% endif %}
                                {% if tipos_datos_por_filas[Frm.id] %}
                                    createeditor: function(row, cellValue, editor, cellText, width, height)
                                    {
                                        var datarow = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', row);
                                        var tipo_control = (datarow.codigo_tipo_control == undefined) ?  '{{campo.tipoControl.codigo}}' : datarow.codigo_tipo_control;
                                        if (datarow.es_separador != 'true'){
                                            if (tipo_control == 'checkbox' || tipo_control == 'checkbox_3_states'){                                                
                                                var element_aux = $('<div></div>')                                                
                                                if (tipo_control == 'checkbox_3_states'){
                                                    var element = $('<div tabIndex=0 style="position: absolute; top: 50%; left: 50%; margin-top: -10px; margin-left: -10px;"></div>');
                                                    editor.append(element);
                                                    element.jqxCheckBox({hasThreeStates: true, animationShowDelay: 0, animationHideDelay: 0});
                                                }
                                                else{
                                                    var element = $('<div tabIndex=0 class="switch_cont" ></div>');
                                                    
                                                    //element.jqxCheckBox({animationShowDelay: 0, animationHideDelay: 0});
                                                    element.jqxSwitchButton({onLabel:'{{'_si_'|trans}}', offLabel:'{{'_no_'|trans}}', width:60, height:25});
                                                    element_aux.append(element);
                                                    editor.append(element);
                                                }
                                            } else if (tipo_control == 'text') {
                                                var inputElement = $("<input type='text' style='width: 100%; height: 100%;' />").prependTo(editor);
                                                inputElement.jqxInput({  width: width, height: height});
                                            } else if (tipo_control == 'datetimeinput') {
                                                var element = $('<input type="datetime"></input>');
                                                editor.append(element);
                                                var fecha = (moment(cellValue).isValid()) ? moment(cellValue, "DD/MM/YYYY HH:mm") : new Date();
                                                element.jqxDateTimeInput({value:fecha.toLocaleString('es-SV'), width: width, height: height, 
                                                    template: "info",
                                                    formatString: 'dd/MM/yyyy HH:mm',
                                                    showTimeButton: true}); 
                                            } else if (tipo_control == 'time') {
                                                var element = $('<input type="time"></input>');
                                                editor.append(element);
                                                var hora =  cellValue.split(':');
                                                var fecha =  moment({hour: hora[0], minute: hora[1]});
                                                
                                                element.jqxDateTimeInput({value:fecha.toLocaleString('es-SV'), width: width, height: height, 
                                                    template: "info",
                                                    formatString: 'HH:mm', showCalendarButton: false,
                                                    culture: 'es-SV', showTimeButton: true});
                                                
                                            } else if (tipo_control == 'Number') {
                                                var inputElement = $("<input type='number' style='width: 100%; height: 100%;' />").prependTo(editor);
                                                inputElement.jqxNumberInput({ template: "info", inputMode: 'simple',decimalDigits : 0,  width: width, height: height});
                                            }
                                        }
                                    },
                                    initeditor : function (row, cellValue, editor, cellText, width, height, pressedkey) {
                                        var datarow = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', row);
                                        var tipo_control = (datarow.codigo_tipo_control == undefined) ?  '{{campo.tipoControl.codigo}}' : datarow.codigo_tipo_control;
                                        if (datarow.es_separador != 'true'){
                                            if (tipo_control == 'checkbox' || tipo_control == 'checkbox_3_states'){
                                                var checkBoxHTMLElement = editor.find('div:first');
                                                //alert(cellValue);
                                                if (tipo_control == 'checkbox_3_states'){
                                                    if (cellValue != undefined){
                                                        if (cellValue.toString() == "true")
                                                            checkBoxHTMLElement.jqxCheckBox({checked: true});
                                                        else if (cellValue.toString() == "false")
                                                            checkBoxHTMLElement.jqxCheckBox({checked: false});
                                                        else
                                                            checkBoxHTMLElement.jqxCheckBox('indeterminate');
                                                    } else{
                                                        checkBoxHTMLElement.jqxCheckBox('indeterminate');
                                                    }
                                                } else {
                                                    n_ = (cellValue == undefined) ? true : (cellValue.toString() == "true") ? false: true;
                                                    //checkBoxHTMLElement.jqxCheckBox({checked: n_});
                                                    checkBoxHTMLElement.jqxSwitchButton({checked: n_});
                                                }
                                                //checkBoxHTMLElement.jqxCheckBox('toggle');
                                                
                                                //checkBoxHTMLElement.jqxCheckBox('toggle');
                                                var val = checkBoxHTMLElement.val();
                                                editor.val(val);
                                            }
                                            else if (tipo_control == 'text'){
                                                var inputField = editor.find('input');
                                                if (pressedkey) {
                                                    inputField.val(pressedkey);
                                                    inputField.jqxInput('selectLast');
                                                }
                                                else {
                                                    inputField.val(cellValue);
                                                    inputField.jqxInput('selectAll');
                                                }
                                            } else if (tipo_control == 'datetimeinput'){
                                                var dateElement = editor.find('div:first');    
                                                //alert(moment('12/12/2012', "DD/MM/YYYY HH:ss"));
                                                
                                                var fecha = (moment(cellValue).isValid()) ? moment(cellValue, "DD/MM/YYYY HH:mm") : new Date();
                                                dateElement.jqxDateTimeInput('val', fecha);
                                                //dateElement.jqxDateTimeInput({width: width, height: height, template: "info",formatString: 'dd/MM/yyyy HH:mm',
                                                  //  showTimeButton: true});
                                            } else if (tipo_control == 'time') {
                                                var dateElement = editor.find('div:first');                                                
                                                var hora =  cellValue.split(':');
                                                var fecha =  moment({hour: hora[0], minute: hora[1]});
                                                dateElement.jqxDateTimeInput('val', fecha);
                                            } else if (tipo_control == 'Number') {
                                                var inputField = editor.find('input');
                                                if (pressedkey) {
                                                    inputField.val(pressedkey);
                                                    inputField.jqxNumberInput('selectLast');
                                                }
                                                else {
                                                    inputField.val(cellValue);
                                                    inputField.jqxNumberInput('selectAll');
                                                }
                                            }
                                        }
                                    },
                                    geteditorvalue : function (row, cellValue, editor) {
                                        var datarow = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', row);
                                        var tipo_control = (datarow.codigo_tipo_control == undefined) ?  '{{campo.tipoControl.codigo}}' : datarow.codigo_tipo_control;
                                        if (datarow.es_separador != 'true'){
                                            if (tipo_control == 'checkbox' || tipo_control == 'checkbox_3_states'){
                                                var checkBoxHTMLElement = editor.find('div:first');
                                                return checkBoxHTMLElement.val();
                                            } else if (tipo_control == 'text'){
                                                return editor.find('input').val();
                                            } else if (tipo_control == 'datetimeinput'){
                                                var dateElement = editor.find('div:first');
                                                var date = new Date(dateElement.jqxDateTimeInput('getDate'));
                                                return date.toLocaleString('es-SV');
                                            } else if (tipo_control == 'time'){
                                                var dateElement = editor.find('div:first');
                                                var date = new Date(dateElement.jqxDateTimeInput('getDate')).toLocaleString('es-SV');
                                                var partes = date.split(' ');
                                                var partes2 = partes[1].split(':');
                                                hora = (parseInt(partes2[0])<10) ? '0'+partes2[0]: partes2[0];                                                
                                                return hora+':'+partes2[1];
                                            } else if (tipo_control == 'Number'){                                                
                                                valor =  editor.find('input').jqxNumberInput('val');
                                                return valor.toString().replace(',', '')
                                            }
                                          return editor.val();
                                        }
                                    },
                                {% endif %}
                                cellsrenderer: function (index, datafield, cellValue, defaultvalue, column, datarow, width, height) {
                                    nivel = (datafield == 'descripcion_variable') ? datarow.nivel_indentacion : 0.3;
                                    estilo = (datarow.es_poblacion == 'true') ? "style='color: blue; margin-left:"+(parseFloat(nivel) * 20)+"px '" :  "style = 'margin-left:"+(parseFloat(nivel) * 20)+"px' ";
                                    estilo = (filaFormula(index, datafield)) ? "style='color: black; font-weight: bold; margin-left:"+(parseFloat(nivel) * 20)+"px '" : estilo;
                                    var tipo_control = (datarow.codigo_tipo_control == undefined) ?  '{{campo.tipoControl.codigo}}' : datarow.codigo_tipo_control;
                                    var valor = cellValue;
                                    // Si es tiempo pasarlo a minutos
                                    if (tipo_control == 'time'){
                                        partes = cellValue.split(':');
                                        valor = parseInt(partes[0]) * 60 + parseInt(partes[1]);
                                    }
                                    if (datarow.alertas != '' && datafield != 'descripcion_variable'){
                                        var rangos = datarow.alertas.split(',');
                                        rangos.forEach(function(nodo, index){
                                            limites = nodo.split('-');
                                            //Si no existe alguno de los límites del rango ponerle valores 
                                            // muy grandes (si falta lim sup) o muy pequeño( si falta el lim inf)
                                            limites[0] = (limites[0]=='') ? -1000000 : limites[0]; 
                                            limites[1] = (limites[1]=='') ? 1000000 : limites[1];
                                            if (!(isNaN(valor))){
                                                if (valor >= parseFloat(limites[0]) && parseFloat(valor) <= parseFloat(limites[1])){                                                    
                                                    estilo = "style='border-style: solid; border-color:"+limites[2]+ " white ; color: " +limites[2]+" ; font-size:14pt; font-weight: bold; margin-left:"+(parseFloat(nivel) * 20)+"px '";
                                                    datarow.rango = limites[2];
                                                }
                                            }
                                        });
                                    }
                                    
                                    if (datarow.es_separador == 'true'){
                                        {% if campo.significadoCampo.codigo  ==  'descripcion_variable' %}
                                            return "<div class='separador_variable jqx-{{campo.alineacion.codigo|default('left')}}-align' "+ estilo + " title='"+datarow.ayuda+"'  data-placement= 'top' >" + cellValue +"</div>";
                                        {% else %}
                                            return "<DIV class= 'separador' style= 'margin-left:"+(parseInt(datarow.nivel_indentacion) * 20)+"px'></DIV>"
                                        {% endif %}
                                    }
                                    {% if tipos_datos_por_filas[Frm.id]  %}
                                        if ( (tipo_control == 'checkbox' || tipo_control == 'checkbox_3_states') && datafield != 'descripcion_variable' ){
                                            var element_aux = $('<div></div>')
                                            if (tipo_control == 'checkbox_3_states'){
                                                /*var element = $('<div tabIndex=0 style="position: absolute; top: 50%; left: 50%; margin-top: -10px; margin-left: -10px;"></div>');
                                                element.jqxCheckBox({hasThreeStates: true, animationShowDelay: 0, animationHideDelay: 0, checked: cellValue.toString() == "true" });
                                                if (cellValue.toString() != 'true' && cellValue.toString() != 'false'){
                                                    element.jqxCheckBox('indeterminate');
                                                }*/
                                                if (cellValue.toString() == 'true')
                                                    estado_ = '<div class="si"><div class="sw_etiqueta">{{'_si_'|trans}}</div><div class="sw_separador"></div></div>';
                                                else if (cellValue.toString() == 'false')
                                                    estado_ = '<div class="no"><div class="sw_separador"></div><div class="sw_etiqueta">{{'_no_'|trans}}</div></div>';
                                                else 
                                                    estado_ = '<div class="na"><div class="sw_etiqueta">{{'_na_'|trans}}</div></div>';
                                                var element = estado_;
                                            } else{
                                                
                                                var estado = (cellValue.toString() == 'true') ? true : false;
                                                estado_ = (estado) ? '<div class="si"><div class="sw_etiqueta">{{'_si_'|trans}}</div><div class="sw_separador"></div></div>'
                                                                : '<div class="no"><div class="sw_separador"></div><div class="sw_etiqueta">{{'_no_'|trans}}</div></div>';
                                                //var element = $('<div tabIndex=0 style="position: absolute;">'+estado_+'</div>');
                                                var element = estado_;
                                                //element.jqxSwitchButton({onLabel:'SÍ', offLabel:'NO', checked:estado, width:60, height:25});
                                            }
                                                //element.jqxCheckBox({animationShowDelay: 0, animationHideDelay: 0, checked: cellValue.toString() == "true" });
                                            element_aux.append(element);
                                            return element_aux.html();
                                        } else {                                            
                                            return "<div class='jqx-{{campo.alineacion.codigo|default('left')}}-align nivel_"+0+"' "+ estilo + " title='"+datarow.ayuda+"'  >" + cellValue +"</div>";
                                        }    
                                    {% else %}
                                        return "<div class='jqx-{{campo.alineacion.codigo|default('left')}}-align nivel_"+datarow.nivel_indentacion+"' "+ estilo + " title='"+datarow.ayuda+"'  data-placement= 'top' >" + cellValue +"</div>";
                                    {% endif %}
                                },
                            },
                            {% endfor %}
                        {% endfor %}
                    ],
                    {% set item_count = 0 %}
                    {% for grp in Frm.gruposColumnas %}
                        {% set item_count = item_count+1 %}
                    {% endfor %}
                    {% if item_count > 0 %}
                        columngroups: [
                            {% for grp in Frm.gruposColumnas %}
                                { text: '{{grp.descripcion}}',
                                    align: 'center',
                                    name: '{{grp.codigo}}',
                                    {% if grp.grupoPadre %} parentgroup: '{{grp.grupoPadre.codigo}}', {% endif %}
                                },
                            {% endfor %}
                        ],
                    {% endif %}
                    rendered: function(){
                        $('.jqx-grid-column-header').each(function(i, nodo){
                            $($($(nodo).children()[0]).children()[0]).css('margin-top',0).css('margin-bottom',0);
                        });
                    },
                    ready: function(){
                        //var texto = $( "div.separador_variable" ).html();
                        $("#jqxgrid{{Frm.id}}").jqxGrid('beginupdate');
                        var elemento = $( "div.separador_variable" ).parent().parent();
                        elemento.addClass('fila_separador');
                        $("#jqxgrid{{Frm.id}}").jqxGrid('endupdate');
                    }
                });

                var listSource = [
                    {% for campo in Frm.campos %}
                        {% if campo.origenPivote %}
                            {% for campoPivote in pivotes[Frm.id][campo.significadoCampo.codigo] %}
                                { label: '{{campoPivote.descripcion}}', value: '{{campo.significadoCampo.codigo}}_{{campoPivote.id}}', checked: true },
                            {% endfor %}
                        {% else %}
                            {% if not(campo.oculto) %}
                                { label: '{{campo.significadoCampo.descripcion}}', value: '{{campo.significadoCampo.codigo}}', checked: true },
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    ];

                    {% if Frm.calculoFilas != '' %}
                    $("#jqxgrid{{Frm.id}}").bind('cellendedit', function (event) {
                        var fila = event.args.rowindex;
                        var columna = event.args.datafield;
                        var valor_celda_actual = event.args.value;
                        var operaciones = '';
                        var datarow = $("#jqxgrid{{Frm.id}}").jqxGrid('getrowdata', fila);
                        
                        var campos = '{{Frm.calculoFilas}}'.split(',');
                        var formula = [];
                        //se espera el formato codigoColumna: {F2} = {F0}/{F1} * 100
                        // Primero se separa por : para obtener el nombre de la columna y la formula
                        // Luego se separa por = para obtener los dos lados de la ecuación
                        // Luego se sustituyen los valores por el dato de la fila correspondiente
                        // y se hace el cálculo 
                        campos.forEach(function(nodo, index){
                            formula = nodo.split(':');
                            //Procesar solamente las fórmulas donde la celda actual aparece
                            if (formula[1].toString().indexOf('{F'+fila+'}') != -1){
                                var campo= new RegExp(formula[0].toString().trim());
                                if (campo.test(columna)){
                                    filasp = /\{F[0-9]{1,2}\}/g;
                                    lados_formula = formula[1].split('=');
                                    fila_destino = filasp.exec(lados_formula[0]).toString().replace(/\{|\}|F/gi,'');
                                    operaciones = lados_formula[1];
                                    operadores = operaciones.toString().match(/\{F[0-9]{1,2}\}/g);
                                    operadores.forEach(function(nodo2, index){
                                        fil = nodo2.toString().replace(/\{|\}|F/gi,'');
                                        valor_oper = (fil == fila) ? valor_celda_actual :  $('#jqxgrid{{Frm.id}}').jqxGrid('getcellvalue', fil, columna);
                                        if (datarow.codigo_tipo_control == 'time'){
                                            hora =  valor_oper.split(':');
                                            valor_oper =  parseInt(hora[0]) * 60 + parseInt(hora[1]);
                                        } else if (datarow.codigo_tipo_control == 'datetimeinput'){
                                            fecha = moment(valor_oper, "DD/MM/YYYY HH:mm")
                                            //valor de la fecha en milisegundos
                                            valor_oper =  fecha.valueOf();
                                        }
                                        operaciones = operaciones.replace(nodo2.toString(), valor_oper);
                                    });
                                    try {
                                        result =  eval(operaciones);
                                        if (datarow.codigo_tipo_control == 'time'){

                                            horas = ~~(parseInt(result) / 60);
                                            horas = ( horas >=0 && horas < 10 ) ? '0'+horas : horas;

                                            minutos = (parseInt(result) % 60)
                                            minutos = ( minutos >= 0 && minutos < 10 ) ? '0'+Math.abs(minutos) : Math.abs(minutos);

                                            result =  horas+ ':' + minutos;
                                        } else if (datarow.codigo_tipo_control == 'datetimeinput'){
                                            //El resultado está en milisegundos, pasarlo a formato hora:minutos                                        
                                            horas_ = result / 1000 / 60 / 60 ;
                                            horas = ~~(horas_);
                                            horas = ( horas >=0 && horas < 10 ) ? '0'+horas : horas;

                                            minutos = (horas_ - horas) * 60;
                                            minutos = ( minutos >= 0 && minutos < 10 ) ? '0'+Math.abs(minutos) : Math.abs(minutos);
                                            result =  horas+ ':' + minutos;
                                        } else {
                                            result = result.toFixed(0);
                                        }
                                        $("#jqxgrid{{Frm.id}}").jqxGrid('setcellvalue', fila_destino, columna, result);
                                    }
                                    catch(err) {
                                        return
                                    }

                                }
                            }
                        });
                    });

                    {% endif %}


                    {% if cantidad_formularios == 1 %}
                        $("#jqxlistbox").jqxListBox({ source: listSource, width: 500, height: 400,  checkboxes: true });
                        $("#jqxlistbox").on('checkChange', function (event) {
                            $("#jqxgrid{{Formularios[0].id}}").jqxGrid('beginupdate');
                            if (event.args.checked) {
                                $("#jqxgrid{{Formularios[0].id}}").jqxGrid('showcolumn', event.args.value);
                            }
                            else {
                                $("#jqxgrid{{Formularios[0].id}}").jqxGrid('hidecolumn', event.args.value);
                            }
                            $("#jqxgrid{{Formularios[0].id}}").jqxGrid('endupdate');
                        });
                    {% endif %}
            }
            {% endfor %}

            {% if cantidad_formularios == 1 %}
                initGrid{{Formularios[0].id}}()
                $("#exportar").click(function () {
                    $("#jqxgrid{{Formularios[0].id}}").jqxGrid('exportdata', 'xls', 'jqxGrid');
                });
                $("#clear").click(function () {
                    $("#jqxgrid{{Formularios[0].id}}").jqxGrid('clear');
                    //$('#mensaje').html('');
                });
            {% elseif cantidad_formularios > 1 %}
                // init widgets.
                var initWidgets = function (tab) {
                    switch (tab) {
                        {% for Frm in Formularios%}
                        case {{ loop.index0 }}:
                            initGrid{{Frm.id}}();
                            break;
                            {% endfor %}
                    }
                }
                $('#jqxTabs').jqxTabs({ width: '100%', height: 560,  initTabContent: initWidgets, theme: 'summer' });
            {% endif %}

            $("#guardar").click(function () {
                if (error){
                    $('#modal_msj_content').html('<div class="alert alert-warning" role="alert">{{'_error_anterior_'|trans}}</div>');
                    $('#modal_msj').modal('show');
                }
                else {
                    $('#modal_msj_content').html('<div class="alert alert-success" role="alert">{{'_datos_guardados_'|trans}}</div>');
                    $('#modal_msj').modal('show');
                }
            });            
            $("#fechaEvaluacion").jqxDateTimeInput({ width: '200px', height: '25px', culture: 'es-SV' });
            $("#guardarConf").click(function () {
                if (isNaN($('#cantidadExpedientes').val())){
                    alert('Cantidad no valida');
                } else {
                    alert(listSource);
                    //$("#jqxgrid{{Formularios[0].id}}").jqxGrid('hidecolumn', event.args.value);
                }
            })

        });
        
        
    </script>
    {% else %}
        <script type="text/javascript">
            $(document).ready(function () {
                //$('[data-toggle="popover"]').popover('show');
                $('#ModalParametros').modal('toggle')
                $("#FiltroListadoFormularios").searchFilter({targetSelector: ".formulario", charCount: 2});
            });
        </script>
    {% endif %}
    {% endblock frm %}
{% endblock javascripts %}
{% block content %}
    <form id="frm_" class="form-inline" >
        <div class="panel panel-primary">
            <div class="panel-heading">
                {% block frm_head %}
                    <DIV class="row">
                        <DIV class="col-sm-6">
                            {% block frm_opciones %}{% endblock %}
                        </div>
                        <div class="col-sm-6">
                            <DIV style="width: 98%; text-align: right" class="prueba">
                                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#ModalParametros">
                                    <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span>{{'_cargar_formulario_'|trans}}
                                </button>
                                {#<button class="btn btn-danger" name="clear" id="clear" ><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>{{'_limpiar_'|trans}}</button>#}
                                <button class="btn btn-warning" type="button" name="guardar" id="guardar" ><i class="fa fa-save" data-original-title="" title=""></i>{{'_guardar_'|trans}}</button>
                                {% if periodoSeleccionado != null and parametros.periodo_estructura != '-1' %}
                                    {% if Formularios[0].areaCosteo() == 'calidad' %}
                                        <button class="btn btn-default" type="button" name="configurar" id="configurar" data-toggle="modal" data-target="#myModalConf" >
                                            <span class="glyphicon glyphicon-cog" aria-hidden="true">{{'_conf_'|trans}}</span>
                                        </button>
                                    {% endif %}
                                {% endif %}
                                <button class="btn btn-instagram" type="button" name="exportar" id="exportar" ><i class="fa fa-archive" data-original-title="" title=""></i>{{'_exportar_'|trans}}</button>
                                {% if periodoSeleccionado != null and parametros.periodo_estructura != '-1' and Frm.rutaManualUso != '' %}
                                    <a href="Frm.rutaManualUso" TARGET="_blank" class="btn btn-info" role="button"><i class="fa fa-question-circle" data-original-title="" title=""></i>{{'_manual_uso_'|trans}}</a>
                                {% endif %}
                                <DIV id="mensaje"></div>
                            </div>
                        </div>
                    </div>
                    <DIV class="descripcion_frm">
                        {% if Frm is defined %}{{Frm.descripcion}}{% endif %}
                    </DIV>
                {% endblock frm_head %}
            </div>
            <div class="panel-body">
                {% block grid %}
                    <div id='jqxWidget' style="padding: 10px;">
                        {% if cantidad_formularios == 1 %}
                        <div role="tabpanel">
                            <ul class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#jqxgrid{{Formularios[0].id}}" role="tab" data-toggle="tab">{{'_cuadro_datos_'|trans}}</a></li>
                                <li role="presentation"><a href="#jqxlistbox" aria-controls="profile" role="tab" data-toggle="tab">{{'_columnas_'|trans}}</a></li>
                            </ul>
                            <div class="tab-content">
                                <div id="jqxgrid{{Formularios[0].id}}" role="tabpanel" class="tab-pane active"></div>
                                <div role="tabpanel" class="tab-pane" id="jqxlistbox"></div>
                            </div>
                        </div>
                        {% elseif cantidad_formularios > 1%}
                        <div id='jqxTabs'>
                            <ul>
                            {% for Frm in Formularios %}
                                <li >
                                    {{Frm.descripcion|default(Frm.id)}}
                                </li>
                            {% endfor %}
                            </ul>
                            {% for Frm in Formularios %}
                                <div style="overflow: hidden;">
                                    <div style="border:none;" id="jqxgrid{{Frm.id}}"></div>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endblock %}
            </div>
        </div>
        {% block frm_foot %} {% endblock frm_foot %}
        <input type="hidden" name="col" id='col' />
        <input type="hidden" name="fil" id='fil' />
    </form>
    <div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" id='modal_msj' aria-labelledby="mySmallModalLabel">
        <div class="modal-dialog modal-sm">
            <div class="modal-content" id="modal_msj_content"></div>
        </div>
    </div>
    <div class="modal fade bs-example-modal-sm" tabindex="-1" data-backdrop="true" data-keyboard= 'true' id='modal_msj_solo_fondo' aria-labelledby="mySmallModalLabel">
        <div class="modal-dialog modal-sm">
            <div class="modal-content"></div>
        </div>
    </div>
    
    <div class="modal fade" id="myModalConf" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
              <h4 class="modal-title" id="myModalLabel">{{'_configuracion_'|trans}}</h4>
            </div>
            <div class="modal-body">
                <form id="frmConf">
                    <div class="form-group">
                      <label for="fechaEvaluacion">{{'_fecha_evaluacion_'|trans}}</label>
                      <input type="date" class="form-control" id="fechaEvaluacion" >
                    </div>
                    <div class="form-group">
                      <label for="nombreResponsable">{{'_nombre_responsable_evaluacion_'|trans}}</label>
                      <input type="text" class="form-control" id="nombreResponsable" >
                    </div>
                    <div class="form-group">
                      <label for="cantidadExpedientes">{{'_cantidad_expedientes_reportar_'|trans}}</label>
                      <input type="integer" class="form-control" id="cantidadExpedientes">
                    </div>
                    <div class="form-group">
                        <label for="observaciones">{{'_observaciones_'|trans}}</label>
                        <textarea name="observaciones" class="form-control" id="observaciones"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" id='guardarConf' class="btn btn-primary">{{'_guardar_'|trans}}</button>
            </div>
          </div>
        </div>
    </div>    
{% endblock content %}
